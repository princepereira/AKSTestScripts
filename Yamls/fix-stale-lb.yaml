apiVersion: v1
kind: ConfigMap
metadata:
  name: check-hns-issue
  namespace: demo
data:
  mitigate-del-lb-issue.ps1: |

    $groups = @("LB_DSR_IPv4_OUT", "LB_DSR_IPv6_OUT")
    $refreshIntervalSeconds = 10

    function Get-DipRangesFromRuleText {
        param([string[]]$RuleText)

        $collect = $false
        $dips = @()

        foreach ($line in $RuleText) {

            # Detect beginning of DIP Range block
            if ($line -match "DIP Range") {
                $collect = $true
                continue
            }

            # Stop when FlagsEx or another header appears
            if ($collect -and $line -match "FlagsEx") {
                break
            }

            # Process lines like:
            # { 10.244.0.25 : 53 }
            # { fdf5:5d67:b9ce:b28f::13f : 4445 }
            if ($collect -and $line.Trim().StartsWith("{")) {

                # Remove surrounding { } then trim
                $clean = $line.Trim().Trim('{','}').Trim()
                # Use regex to extract IP before last " : "
                if ($clean -match '(.+)\s*:\s*\d+$') {
                    $ip = $matches[1].Trim()
                    $dips += $ip
                }
            }
        }

        return $dips
    }

    $regKeyVal = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides" -Name 140377743).140377743
    if ($regKeyVal -eq 1) {
        Write-Host "Registry keys are not zero. Setting reg key to 0 and restarting the node." -ForegroundColor Yellow
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides" -Name 140377743 -Value 0 -Type DWORD
        Restart-Computer -Force
        Start-Sleep -Seconds 30
    } else {
        Write-Host "Registry keys are zero. Continuing the script." -ForegroundColor Green
    }

    While($true) {
        Write-Host "Waiting for $refreshIntervalSeconds seconds for the next iteration..." -ForegroundColor Cyan
        Start-Sleep -Seconds $refreshIntervalSeconds
        Write-Host "Starting new iteration to check for stale LB DSR rules..." -ForegroundColor Cyan
        $dictDstIPs = @{}

        $policies = Get-HnsPolicyList

        $endpointIds = $policies.References |
            Where-Object { $_ -like "/endpoints/*" } |
            ForEach-Object { ($_ -split "/")[-1] } |
            Sort-Object -Unique

        $endpointIds | ForEach-Object {
            $ipAddress = (Get-HnsEndpoint -Id $_).IPAddress
            if ($ipAddress -ne $null) {
              $dictDstIPs[$ipAddress] = $true
            }
            $ipv6Address = (Get-HnsEndpoint -Id $_).IPv6Address
            if ($ipv6Address -ne $null) {
              $dictDstIPs[$ipv6Address] = $true
            }
        }

        $ports = (vfpctrl.exe /list-vmswitch-port /format 1 | ConvertFrom-Json).Ports.Name
        foreach ($port in $ports) {
            foreach ($group in $groups) {
                $rules = (vfpctrl /port $port /layer LB_DSR /group $group /list-rule /format 1 | ConvertFrom-Json).Rules
                foreach ($rule in $rules) {
                    $ruleId = $rule.Id
                    $ruleText = vfpctrl /get-rule-info /port $port /layer LB_DSR /group $group /rule $ruleId 2>&1
                    if (-not $ruleText) {
                        Write-Host "No output from vfpctrl"
                        continue
                    }

                    $dips = Get-DipRangesFromRuleText -RuleText $ruleText
                    # Check which DIPs are missing in the dictionary
                    $missingDIPs = $dips | Where-Object { -not $dictDstIPs.ContainsKey($_) }

                    if ($missingDIPs.Count -eq 0) {
                        Write-Host "All DIP ranges are present in the dictionary." -ForegroundColor Green
                    } else {
                        Write-Host "Missing DIP ranges:" -ForegroundColor Red
                        $missingDIPs | ForEach-Object { Write-Host " - $_" }
                        Write-Host "Deleting rule : ruleId: $ruleId, port: $port, group: $group" -ForegroundColor Yellow
                        vfpctrl /remove-rule /port $port /layer LB_DSR /group $group /rule $ruleId
                    }
                }
            }
        }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: stale-lb-rules-mitigator
  namespace: demo
  labels:
    app: stale-lb-rules-mitigator
spec:
  selector:
    matchLabels:
      app: stale-lb-rules-mitigator
  template:
    metadata:
      labels:
        app: stale-lb-rules-mitigator
    spec:
      securityContext:
        windowsOptions:
          hostProcess: true
          runAsUserName: 'NT AUTHORITY\SYSTEM'
      hostNetwork: true
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - windows
      containers:
      - name: stale-lb-rules-mitigator
        image: mcr.microsoft.com/dotnet/framework/samples:aspnetapp
        imagePullPolicy: IfNotPresent
        command:
          - powershell.exe
          - -File
          - C:\scripts\mitigate-del-lb-issue.ps1
        volumeMounts:
          - name: script
            mountPath: C:\scripts
          - name: kube-path
            mountPath: C:\k
      terminationGracePeriodSeconds: 60
      volumes:
        - name: script
          configMap:
            name: check-hns-issue
        - name: kube-path
          hostPath:
            path: C:\k
            type: DirectoryOrCreate